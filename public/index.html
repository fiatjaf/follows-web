<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/icons/favicon-128x128.png" />
  <link rel="apple-touch-icon" sizes="128x128" href="/icons/favicon-128x128.png" />
  <link rel="manifest" href="/manifest.json" crossorigin="use-credentials" />
  <link rel="shortcut icon" type="image/png" href="/icons/favicon-196x196.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png" />
  <link rel="stylesheet" type="text/css" href="/styles/main.css">
  <meta name="msapplication-TileColor" content="#ffffff" />
  <meta name="theme-color" content="#ffffff" />
	<title>follows.lol - The Nostr follower tool</title>
	<script src="https://unpkg.com/nostr-tools"></script>
	<style>
	* {
		padding: 0;
		margin: 0;
		box-sizing: border-box;
	}
	html {
		font-size: 62.5%;
		min-height: 100vh;
	}

	body {
		font-family: sans-serif;
		font-size: 1.6rem;
		min-height: 100vh;
	}

	main {
		min-height: calc(100vh - 8.4rem);
		display: flex;
		justify-content: flex-start;
		align-items: center;
		flex-direction: column;
	}

	h1 {
		font-weight: 700;
		font-size: 2.2rem;
	}

	form {
		margin-top: 6rem;
	}

	input, button {
		padding: 1.2rem;
	}

	button {
		font-weight: 700;
	}

	footer {
		margin: 1.2rem;
		text-align: center;
	}
	</style>
<script>
// Your Nostr private key
//const privateKey = 'your_private_key'; // Replace with your actual private key

// Function to get followers for a given npub
async function getAndFollowUsersFollowers(targetNpub) {
		//const { relayInit, finishEvent, generatePrivateKey, getPublicKey } = window.nostr;
    const relayUrl = 'wss://relay.primal.net'; // Replace with your chosen relay URL
    const client = new nostr.Client();

    // Connect to the relay
    await client.connect(relayUrl);

    // Subscription to get 'meta' events
    const subscription = {
        filter: {
            kinds: [4], // Kind 4 for 'meta' events
            authors: [targetNpub] // The npub of the target user
        },
        cb: (event) => {
            // Handle the event - extract followers
            if (event.content && event.content.follow) {
                event.content.follow.forEach(async (followerNpub) => {
                    // Follow each follower
                    await followUser(followerNpub, client);
                });
            }
        }
    };

    client.subscribe(subscription);
}

// Function to follow a user
async function followUser(followerNpub, client) {
		const { pubkey } = (await window.webln.getInfo()).node;
		const pubkey2 = await window.nostr.getPublicKey();
    const event = {
        pubkey,
        kind: 4, // Kind 4 for 'meta' events
        content: {
            follow: [followerNpub]
        },
        tags: [],
        created_at: Math.floor(new Date().getTime() / 1000),
    };

    // Sign the event with your private key
		async window.nostr.signEvent(event); // takes an event object, adds `id`, `pubkey` and `sig` and returns it
   // event.id = nostr.getEventId(event, privateKey);
    //event.sig = nostr.getEventSignature(event, privateKey);

    // Publish the event
    await client.publish(event);
}

async function createInvoiceAndPay() {
		if (typeof window.webln === 'undefined') {
			return;
		}

		await window.webln.enable();
		const res = await fetch('https://globalthreat.info/api/payments/invoice', {
			method: 'POST',
			headers: {
				'content-type': 'application/json',
			},
			body: JSON.stringify({
				description: 'get my follow on at follows.lol!'
			})
		});

		const invoice = await res.json();

		const result = await webln.lnurl('zap@pay.globalthreat.info');

		console.log(result);	
}

async function onSubmit(e) {
	e.preventDefault();
	const targetUserNpub = document.getElementById('npub').value;

	getAndFollowUsersFollowers(targetUserNpub);
}

window.addEventListener('DOMContentLoaded', function() {
	document.getElementById('follow').addEventListener('submit', onSubmit);
});

</script>
</head>
<body>
<main>
	<form id="follow" method="post">
		<h1 style="text-align: center;">The Nostr follower tool</h1>
		<div class="field"><input id="npub" style="width: 50vw" type="text" placeholder="npub" /> <button>follow</button></div>
	</form>
</main>

<footer>
	<p><small>follow my followers: <a href="#" onclick="document.getElementById('npub').value = 'npub19p3l898yf76s73m5pr0ru03a0y8ps6c3se6xcekz8d8v2f676kxs5vwdmw'; return false">npub19p3l898yf76s73m5pr0ru03a0y8ps6c3se6xcekz8d8v2f676kxs5vwdmw</a></small></p>
</footer>
</body>
</html>

